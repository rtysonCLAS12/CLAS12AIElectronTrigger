import numpy as np
from sklearn.ensemble import AdaBoostClassifier
from sklearn.ensemble import GradientBoostingClassifier
from sklearn.neural_network import MLPClassifier
from sklearn.model_selection import train_test_split
from sklearn.utils import class_weight
from sklearn import metrics
from sklearn import preprocessing
from sklearn import decomposition
from sklearn.metrics import log_loss
from matplotlib import pyplot
from matplotlib.colors import LogNorm
from tensorflow.keras.models import load_model
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv1D, MaxPooling1D, Reshape
from tensorflow.keras.layers import Conv2D, MaxPool2D, Input, concatenate
from tensorflow.keras.layers import Activation, Dropout, Flatten, Dense
from tensorflow.keras import optimizers as opt 
from tensorflow.keras import metrics as mt
from tensorflow.keras import backend as K
import tensorflow as tf
import math
import time
import seaborn as sns


def nll_loss_fn(y_true, y_pred):
    return K.sum(K.binary_crossentropy(y_true, y_pred), axis=-1)

#tf.keras.backend.set_learning_phase(0)

t0 = time.time()
saveDir='/home/richardt/public_html/aiTrig/training2D/'

signal=np.load("/w/work5/jlab/hallb/clas12/rg-a/trackingInfo/trainingSamples/Sector_signal19_2D.npy")

endName='_s1' 

#print(signal.shape)

#for i in range(1, 29):
for i in range(20,21):
    print("signal"+str(i))
    a = np.load("/w/work5/jlab/hallb/clas12/rg-a/trackingInfo/trainingSamples/Sector_signal"+str(i)+"_2D.npy")
    #print(a.shape)
    signal=np.vstack((signal,a))

print(signal.shape)

signalLab0=np.zeros([len(signal),1])
signalLab1=np.ones([len(signal),1])
signalLab=np.vstack((signalLab1,signalLab0))

#print(signalLab.shape)
bg=np.load("/w/work5/jlab/hallb/clas12/rg-a/trackingInfo/trainingSamples/Sector_bg19_2D.npy")
#for i in range(1,29):
for i in range(20,21):#29
    print("bg"+str(i))
    b=np.load("/w/work5/jlab/hallb/clas12/rg-a/trackingInfo/trainingSamples/Sector_bg"+str(i)+"_2D.npy")
    bg=np.vstack((bg,b))
    
print(bg.shape)
bg=bg[0:len(signal),:]
bgLab0=np.zeros([len(bg),1])
bgLab1=np.ones([len(bg),1])
bgLab=np.vstack((bgLab0,bgLab1))
#print(bg.shape)
X= np.vstack((signal,bg))
Y= np.hstack((signalLab,bgLab))

print(X.shape)

X_DC=X[:,:,:112]

X_EC=X[:,:,112:]

model = load_model('trained_CNN_2D_Sector.h5')
#, custom_objects={'nll_loss_fn': nll_loss_fn})

t0_inf = time.time()

#y_prob = model.predict({"DC": X_DC, "EC": X_EC},batch_size=128)[:, 0]

y_prob = model.predict(X,batch_size=128)[:, 0]

t1_inf = time.time()
#print("pred end")
time_inf=t1_inf-t0_inf

rate=len(Y)/time_inf

print(" Inference time: "+str(time_inf)+"s for "+str(len(Y))+" events.")
print("ie rate of "+str(rate)+" Hz")
print("ie per event "+str(rate/6)+" Hz")
print("ie per record "+str(rate/600)+" Hz \n")

y_testSigCol=Y[:,0]
threshB=0
bestAcc=0
bestPur=0
bestSen=0
bestPuratSen=0
bestPS=0
bestThresh=0
proba0=[]
proba1=[]
Thresh=[]
Acc=[]
Pur=[]
Sen=[]
PS=[]
for j in range(0,100):
#for j in range(1,2):
    thresh=threshB+(j*0.01)
    Thresh.append(thresh)
    TP=0
    TN=0
    FN=0
    FP=0
    ind=0
    for i in (y_prob):
        if y_testSigCol[ind]==0:
            if j==0:
                proba0.append(i)
            if i <= thresh:
                TN=TN+1
            else:
                FP=FP+1
        else:
            if j==0:   
                proba1.append(i)
            if i > thresh:
                TP=TP+1
            else:
                FN=FN+1
        ind=ind+1
    probAcc=(TP+TN)/ind 
    Acc.append(probAcc)
    pur=TP/(TP+FP)
    Pur.append(pur)
    sen=TP/(TP+FN)
    Sen.append(sen)
    ps=pur*sen
    PS.append(ps)
    if sen>0.995:
        fthresh="{:.4f}".format(thresh)
        fpur="{:.4f}".format(pur)
        fsen="{:.4f}".format(sen)
        fprobAcc="{:.4f}".format(probAcc)
        print('Thresh '+str(fthresh)+' Pur '+str(fpur)+' Sen '+str(fsen)+' Acc '+str(fprobAcc))
    if probAcc > bestAcc:
        bestAcc=probAcc
        bestThresh=thresh
    if pur > bestPur:
        bestPur=pur
    if sen > bestSen:
        bestSen=sen
    if ps > bestPS:
        bestPS=ps
    if sen>=0.999:
        if pur>bestPuratSen:
            bestPuratSen=pur

print('Rate: '+str(rate)+' PaS: '+str(bestPuratSen))

fig = pyplot.figure()
pyplot.hist(proba1, range=[0,1],bins=100, label='Positive Sample')
pyplot.hist(proba0, range=[0,1],bins=100, edgecolor='red',label='Negative Sample',hatch='/',fill=False)
pyplot.legend(loc='upper center')
pyplot.xlabel('Response')
pyplot.title('Response')
pyplot.yscale('log', nonpositive='clip')
pyplot.savefig(saveDir+'response'+endName+'.png')

fig = pyplot.figure()
pyplot.scatter(Thresh, Acc, marker='o', color='green',label='Accuracy')
pyplot.scatter(Thresh, Pur, marker='o', color='red',label='Purity')
pyplot.scatter(Thresh, Sen, marker='o', color='blue',label='Efficiency')
pyplot.scatter(Thresh, PS, marker='o', color='darkviolet',label='P*E')
pyplot.ylim(0.825, 1.01)
pyplot.legend(loc='lower center')
pyplot.xlabel('Lower Threshold on Response')
pyplot.ylabel('Metrics')
pyplot.axhline(y = 1.0, color = 'black', linestyle = '--') 
pyplot.axhline(y = 0.995, color = 'grey', linestyle = '--') 
pyplot.title('Metrics vs Response Lower Threshold')
pyplot.savefig(saveDir+'metrics_response'+endName+'.png')

t1 = time.time()
time=t1-t0
time_m=time/60
print("Total time: "+str(time)+"s ie "+str(time_m)+" minutes.")
